from mcp.server.fastmcp import FastMCP
import os
import logging
import httpx
import requests
import socket



#创建日志器
logger = logging.getLogger()
#设置日志级别
logger.setLevel(logging.INFO)

#创建控制台处理器（StreamHandler）
console_handler = logging.StreamHandler()
console_handler.setLevel(logging.INFO)

#创建文件处理器（FileHandler）
file_handler = logging.FileHandler('mcp-server-cse-python.log', mode='a')
file_handler.setLevel(logging.INFO)

#创建日志格式器
formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')

#将格式器添加到处理器
console_handler.setFormatter(formatter)
file_handler.setFormatter(formatter)

#将处理器添加到日志器
logger.addHandler(console_handler)
logger.addHandler(file_handler)

#Initialize FastMCP server
mcp = FastMCP("CSEEngineServer")

#通过postman请求获得，去华为云官网查看如何获取iam_auth_token
TOKEN = "MIIXCAYJKoZIhvcNAQcCoIIW+TCCFvUCAQExDTALBglghkgBZQMEAgEwghSTBgkqhkiG9w0BBwGgghSEBIIUgHsidG9rZW4iOnsiZXhwaXJlc19hdCI6IjIwMjUtMDctMjZUMDE6NTM6MDYuNTYxMDAwWiIsInNpZ25hdHVyZSI6IkVBcGpiaTF1YjNKMGFDMDNBQUFBQUFBQUJFc1Z2Rlhja3YwUFhDVjkxS1ZLT3FiM2kyRG9wM3FTNEdWQXM2VjlRN0tvekxsM0R0RTB3ZEFkMWdHak4xTjJWdTdXNG1KbDVTWXYrakhRcis0anNONlVnZzAvZUlweHB4SFlpWDMzQjlCVFl4NlFvRHB6UTZnMC9pczY4aDN6SjhEazdvUk9DSUtVODVlN3luZ0hzazZBU29hRWFhOGh4czFPS2tVeDc4eW9peVVmVlpScllmeXJRMGFiS2NiZ1p1cDZoUFA0d2w4SEcydTRLL0w5c3JVVE0vUFc5bUE0Mzdpd3JseXlBSmhNRXdiYXY4ZXlnNDY2ZVBsd0tkdU9lZDAreVdwSDh5SzZQOTJxQlAvYVZha1ZrL2wrTnA4UjdKVGFocmZqc2U5R2JPaG5zeEZ3cUJ0eWJMTWRETmhUbTZtVDFVOXlmSmhsSmNPb0Y2SFhJQ3Q3IiwibWV0aG9kcyI6WyJwYXNzd29yZCJdLCJjYXRhbG9nIjpbXSwicm9sZXMiOlt7Im5hbWUiOiJ0ZV9hZG1pbiIsImlkIjoiMCJ9LHsibmFtZSI6ImNjaV9hZG0iLCJpZCI6IjAifSx7Im5hbWUiOiJvYnNfYl9saXN0IiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfZGNzX21zX3J3cyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2JldGFfY3NzX3NlcnZlcmxlc3MiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9jY2VfdHVyYm9fZW5oYW5jZWQiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX2Nsb3VkZGMiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX2ZhYnJpYyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2JldGFfcm9ja2V0bXFfc2VydmVybGVzcyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX21lZXRpbmdfZW5kcG9pbnRfYnV5IiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfb3BfZ2F0ZWRfY3IiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX211bHRpX2Nsb3VkX3ZlcnNpb24iLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9zaXNfc2Fzcl9lbiIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2NmdyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX29wX2dhdGVkX2lydGMiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX2lfY29jX2NhIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfcmVkaXM2LWdlbmVyaWMtaW50bCIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2JldGFfaV9rb29waG9uZSIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX29wX2dhdGVkX2V2c19lc3NkMiIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2Rjc19kY3MyLWVudGVycHJpc2UiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9jb2NfY2EiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9pZG1lX21ibV9mb3VuZGF0aW9uIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfY3ZyIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfbWFzIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfa29vcGhvbmUiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX2t2cyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX211bHRpX2JpbmQiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9yb21hZXhjaGFuZ2UiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX21nY19iaWdkYXRhbWlncmF0aW9uIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfY2VyIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfa29vbWFwIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfZXZzX2Vzc2QyIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfcGVkYV9zY2hfY2EiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF91Y3NfY2lhIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfY2llIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfaHdkZXYiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX2lfY2NlX2F1dG9waWxvdCIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX3Zwbl92Z3dfaW50bCIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2JldGFfZWxhc3RpY19uYXQiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9kYXl1X2RsbV9jbHVzdGVyIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfZWNzX2FjNyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2hzZC1wdCIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2NvbXBhc3MiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9ubHBfbGdfdGciLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9pYW1faWRlbnRpdHljZW50ZXJfY24iLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX2lfcmdjX2ludGwiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9zZnNfbGlmZWN5Y2xlIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfaW90ZWRnZV9iYXNpYyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX3NlcnZpY2VzdGFnZSIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2FwcHN0YWdlIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfb3BfZ2F0ZWRfb25ldGFsayIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX3VjcyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX3JpX2R3cyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2F0YyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2Jjc19uZXNfc2ciLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9zaXNfYXNzZXNzX2F1ZGlvIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfb3NjIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfYmV0YV9pX2Nsb3VkcG9uZCIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX3Vjc19vbl9wcmVtaXNlc19pbnRsIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfb3BfZ2F0ZWRfZGRzX2FybSIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2VjcCIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2JldGFfaWRlZV9jYSIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2lkbWVfbGlua3hfZm91bmRhdGlvbiIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2Rjc19kY3MyLXJlZGlzNi1nZW5lcmljIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfb3BfdGVzdGdvbmdjZTAxMjYiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9kbXMtcm9ja2V0bXE1LWJhc2ljIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfZGx2X29wZW5fYmV0YSIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2ZpbmVfZ3JhaW5lZCIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX3Zwbl92Z3ciLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX2Nlc193YW5tb25pdG9yX2NuIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfS29vTWVzc2FnZUNPQlQiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9kbXNfcmVsaWFiaWxpdHkiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9vcF90ZXN0Z29uZ2NlIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfb3BfdGVzdGdvbmdjZTAxMjYyMyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX3JnYyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2lkdF9kbWUiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9lY3Nfb2ZmbGluZV9hYzciLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9vcF9nYXRlZF9zZnN0dXJib2JldGEiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9sZWdhY3kiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX2lfd3NhX2NhIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfZG1zLWFtcXAtYmFzaWMiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9kZXZjbG91ZF9vdmVyc2VhX2JldGEiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iY2UiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9jY2VfYXV0b3BpbG90IiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfaW50bF9jb21wYXNzIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfdWNzX29uX2F3c19pbnRsIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfYmV0YV9kZnBzZXJ2aWNlIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfV2VMaW5rX2VuZHBvaW50X2J1eSIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX29wX2dhdGVkX3JvdW5kdGFibGUiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9pb3RhbmFseXRpY3MiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9iZXRhX2NyYWZ0YXJ0c3NpbV9jYSIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2lwc2VjdnBuX09CVCIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2JldGFfZWdfcm91dGVyIiwiaWQiOiIwIn0seyJuYW1lIjoib3BfZ2F0ZWRfZHdyX2JldGEiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9JUERDZW50ZXJfQ0FfMjAyMzA4MzAiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9vcF9nYXRlZF9tZ2MiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9jciIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX21hcF92aXNpb24iLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF9kY3MzLWVudGVycHJpc2UiLCJpZCI6IjAifSx7Im5hbWUiOiJvcF9nYXRlZF91Y3Nfb25wcmVtaXNlcyIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX3dpZmktYmV0YSIsImlkIjoiMCJ9LHsibmFtZSI6Im9wX2dhdGVkX2JldGFfaV9zZnNfbGlmZWN5Y2xlIiwiaWQiOiIwIn0seyJuYW1lIjoiMzIsNDEsMzQwLDIwNyw5LDE2NCwyMjgsNDAiLCJpZCI6IjgifSx7Im5hbWUiOiIyNiIsImlkIjoiOSJ9XSwicHJvamVjdCI6eyJkb21haW4iOnsibmFtZSI6InBhYXNfY3NlX2x3eDQxMDk0MF8wMSIsImlkIjoiZmNhYTRjMGQxOGUyNGRmMzhlODgxYzI4ZWM0ZGRiNWUifSwibmFtZSI6ImNuLW5vcnRoLTciLCJpZCI6Ijc5YzQwODZmNWYzYTRlMzRhOTI2MDFkZmM2NGIxZThjIn0sImlzc3VlZF9hdCI6IjIwMjUtMDctMjVUMDE6NTM6MDYuNTYxMDAwWiIsInVzZXIiOnsiZG9tYWluIjp7Im5hbWUiOiJwYWFzX2NzZV9sd3g0MTA5NDBfMDEiLCJpZCI6ImZjYWE0YzBkMThlMjRkZjM4ZTg4MWMyOGVjNGRkYjVlIn0sIm5hbWUiOiJ3dXpoaWhlbmciLCJwYXNzd29yZF9leHBpcmVzX2F0IjoiMjAyMy0wMy0xOFQwMjozMjoxMy4wMDAwMDBaIiwiaWQiOiIxNjA3NzY1YzAyOGU0OTYzYTUxODI1YTI5MzI3ZmIyMSJ9fX0xggJIMIICRAIBATCBnjCBhTELMAkGA1UEBhMCQ04xEjAQBgNVBAgMCUd1YW5nRG9uZzERMA8GA1UEBwwIU2hlblpoZW4xLjAsBgNVBAoMJUh1YXdlaSBTb2Z0d2FyZSBUZWNobm9sb2dpZXMgQ28uLCBMdGQxDjAMBgNVBAsMBUNsb3VkMQ8wDQYDVQQDDAZpYW1wa2kCFF5Nhgd5lJK8NiTuBYBLAwRkSdmjMAsGCWCGSAFlAwQCATANBgkqhkiG9w0BAQEFAASCAYA6IXd9zNeVoVi77Hdp0QgzJkODQLXtkfw3-8PaGppSAajrsKUEZFPxIXzOyjRyq7MA-TgXpJEGFmW78pe7Jr583Q1IKRUj0MkN-3dDDZ0I04NYMCPeMkhGvyOqyWbxdgr3uot2luWjh2JP7Avku8CfT-umIgxItiLGR8f-Qjve9u+gbxN3CzL4YNUnpONn2rnEHEzdaHex78lCcPNc4N8JGhxoLNpNf9+n-nBc9PaNeMpbczNdUR438LN0XuMvMhb1UQT7z4uXGXSyeKop8iC+vpMcASEHX338VXOVGJeLT4U7slBoQXou9VJ2ylABl2AIF5sDbfJ1W355YOJ-PRN2jd70rtWacy+qiJ1B3Ud1QBGh-YWfAqY5LDrjyBtaY0xfQBhZXm0QXUB0pqgCutUyBGvdNuuX6PKTaKF8FVjaOaFqxZaKK9vRQYZLQ0hBsIxC6qSqaVeLxWVp-RP10Pi71ELidJZQrKL9MBCuLg0+Yf9FgmboCWocbNbXOFWdizA="

#在华为云官网中查看
Project_id = "79c4086f5f3a4e34a92601dfc64b1e8c"

# 在请求前添加IP解析验证
try:
    resolved_ip = socket.gethostbyname('cse.cn-north-7.myhuaweicloud.com')
    logger.info(f"域名解析结果: cse.cn-north-7.myhuaweicloud.com -> {resolved_ip}")
except socket.gaierror as e:
    logger.error(f"域名解析失败: {e}")

base_url = "https://cse.cn-north-7.myhuaweicloud.com/v2"
url = f"{base_url}/{Project_id}/enginemgr/engines"

# 构建请求头 - 需要使用签名字符串进行认证
# headers = {
#     'X-Auth-Token': TOKEN,  # 需要替换为实际的签名字符串
#     'Content-Type': 'application/json'
# }


base_url =  "http://100.85.123.17:8848/nacos/v1"


base_url =  "http://100.85.123.17:8848/nacos/v1"
url = f"{base_url}/ns/service"

params = {
    'serviceName':"lllds"
}

headers = {
    'X-Auth-Token' : TOKEN,
    'content-Type' : 'application/json'
}

logger.info(f"正在创建服务")
response = requests.post(url, params=params, headers=headers, verify=False, timeout=30)
response.raise_for_status()
if response.text.strip() == 'ok':
    logger.info(f"成功创建服务")
        
print(response.text)

logger.info(f"成功创建服务")


url = f"{base_url}/ns/service/list"

params = {
    'pageNo':1,
    'pageSize' : 2
}

headers = {
    'X-Auth-Token' : TOKEN,
    'content-Type' : 'application/json'
}

logger.info(f"正在查询服务列表")
response = requests.get(url,params=params,  verify=False, timeout=30)
response.raise_for_status()
print(response)
data = response.json()
print(data)
count = data.get('count')

print(count)

logger.info(f"成功查询服务列表信息")

